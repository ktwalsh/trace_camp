{% extends "home.html" %}
{% block body %}
<section class="text-center masthead">
    <!-- Load script and add some css for map picker -->
    <script type="text/javascript"
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC35jBVPFgwUoXf90cLVIU--lg7gW6HyTU"></script>
    <script src="https://unpkg.com/location-picker/dist/location-picker.min.js"></script>
    <style type="text/css">
        #map {
            width: 100%;
            height: 480px;
        }
    </style>
    <h1>Create Event</h1>
    <div class="container">
        <!-- Event creation form -->
        <form method="post">{% csrf_token %}
            <div class="form-group">

                <label for="title">Title</label>
                <textarea name="title" cols="40" rows="1" required="" id="id_title"
                    class="form-control">{{form.title.value|default:""}}</textarea>
                <label for="description">Description</label>
                <textarea name="description" cols="40" rows="1" required="" id="id_description"
                    class="form-control">{{form.description.value|default:""}}</textarea>
                <br>
                <label for="date">Date of Event</label>
                <input type="date" name="date" value="{{form.date.value}}">
                <label for="time">Time of Event</label>
                <input type="time" name="time" value="{{form.time.value}}">
                <br>
                <label for="location">Location</label>


                <!-- Displays the current coordinates -->
                <p><span id="onIdlePositionView"></span></p>
                <!-- Displays the closest address of the current position -->
                <p>Address: <span id="onClickParseView"></span></p>
                <!-- Hidden field that assigns the current position to the location of the event object -->
                <p hidden>Chosen address: <textarea class="form-control" name=location cols='40' rows='10' required=""
                        id="onClickAddressView">{{form.location.value}}</textarea></p>
                <div id="map"></div>
                <script>

                    // Get element references
                    var onClickPositionView = document.getElementById('onClickPositionView');
                    var onIdlePositionView = document.getElementById('onIdlePositionView');
                    var onClickAddressView = document.getElementById('onClickAddressView')
                    var onClickParseView = document.getElementById('onClickParseView')
                    console.log('{{object.location|safe}}')
                    if ('{{object.location|safe}}' === "") {
                        var lp = new locationPicker('map', {
                            setCurrentPosition: true,
                        }, {
                                zoom: 15
                            })
                    } else {
                        var parsed = JSON.parse('{{object.location|safe}}')
                        var lp = new locationPicker('map', {
                            setCurrentPosition: true,
                            lat: parsed.address.lat,
                            lng: parsed.address.lng// You can omit this, defaults to true
                        }, {
                                zoom: 15 // You can set any google map options here, zoom defaults to 15
                            });
                    }

                    // Initialize locationPicker plugin



                    // Listen to map idle event, listening to idle event more accurate than listening to ondrag event
                    google.maps.event.addListener(lp.map, 'idle', function (event) {
                        // Get current location and show it in HTML
                        var location = lp.getMarkerPosition();
                        onIdlePositionView.innerHTML = 'The chosen location is ' + location.lat + ',' + location.lng;
                        // Sends API request and returns address based on lat and long 
                        const Http = new XMLHttpRequest();
                        const url = `http://api.geonames.org/findNearestAddressJSON?lat=${location.lat}&lng=${location.lng}&username=klevinw`
                        Http.open("GET", url);
                        Http.send();
                        // changes both readable and raw variables to current position
                        Http.onreadystatechange = (e) => {
                            var parse = JSON.parse(Http.responseText)
                            console.log(Http.responseText)
                            onClickParseView.innerHTML = `${parse.address.streetNumber} ${parse.address.street}, ${parse.address.placename}, ${parse.address.adminName1}, ${parse.address.postalcode}`
                            onClickAddressView.innerHTML = Http.responseText
                        }
                    });


                </script>
                <br>
                <input type="submit" value="Create Event" class="form-control">
            </div>
        </form>
    </div>
</section>

{% endblock %}